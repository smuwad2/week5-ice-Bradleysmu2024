<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT"
      crossorigin="anonymous"
    />

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  </head>

  <body onload="getCategories()">
    <div class="container-fluid">
      <h1 class="text-center">Supermarket</h1>
      <div class="row">
        <div class="col-md-3">
          <span class="lead text-center">Category</span>
        </div>
        <div class="col-md-9">
          <select class="form-select" onchange="getItems()" id="selectCategory">
            <option value="0">To select</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <div id="itemsList" class="row my-3 py-3">
        <p class="text-center">No items</p>
      </div>
    </div>

    <script>
  // optional tiny cart so the button works
  const cart = { items: [], add(it){ this.items.push(it); } };

  async function getCategories() {
    try {
      const { data } = await axios.get("/categories"); // <-- await
      showCategories(data);

      document.getElementById("selectCategory").value = "all";
      await getItems(); // load items on first paint
    } catch (error) {
      console.log("Failed to load categories:", error.message);
    }
  }

  function showCategories(categories) {
    const selectElement = document.getElementById("selectCategory");
    // keep "To select" and "All"
    selectElement
      .querySelectorAll("option:not([value='0']):not([value='all'])")
      .forEach(o => o.remove());

    if (!Array.isArray(categories)) return;

    categories.forEach(category => {
      const option = document.createElement("option");
      option.value = category;
      option.textContent = category;
      selectElement.appendChild(option);
    });
  }

  async function getItems() {
    const chosen = document.getElementById("selectCategory").value;
    if (chosen === "0") return;

    try {
      const { data } = await axios.get("/items", {
        params: chosen === "all" ? {} : { category: chosen }
      });
      showItems(data);
    } catch (err) {
      console.error("Failed to load items:", err.message);
      document.getElementById("itemsList").innerHTML =
        `<p class="text-center text-danger">No items found.</p>`;
    }
  }

  function showItems(items) {
    const container = document.getElementById("itemsList");
    if (!Array.isArray(items) || items.length === 0) {
      container.innerHTML = `<p class="text-center">No items</p>`;
      return;
    }

    const html = items.map(item => {
      const price = Number(item.price).toFixed(2);
      return `
        <div class="col-lg-4 col-md-6 col-12 mb-3">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title mb-1">${item.name}</h5>
              <p class="text-muted mb-2">Category: ${item.category}</p>
              <p class="mb-2">Price: $${price}</p>
              <p class="mb-3">Qty in stock: ${item.quantity}</p>
              <button class="btn btn-primary mt-auto"
                onclick='cart.add(${JSON.stringify(item)})'>
                Add to Cart
              </button>
            </div>
          </div>
        </div>`;
    }).join("");

    container.innerHTML = html;
  }
</script>


    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
      crossorigin="anonymous"
    ></script>
  </body>
</html>
